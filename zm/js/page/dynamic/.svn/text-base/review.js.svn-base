define(["app","mui","vue","mui.previewimage","mui.zoom"],function(d,b,h,k,l){new h({el:"#app",data:{par:{postId:"",pageIndex:0,pageSize:15},isIOS:b.os.ios?"ios":"",pageid:"",isUp:!0,pageCount:0,list:[],o:null,parReview:{postId:"",content:"",discussType:1},ui:{h:document.getElementById("h"),txtAsk:document.getElementById("txtAsk"),footer:document.getElementById("footer"),content:document.querySelector(".mui-content"),btnSave:document.getElementById("btnSave"),txtFocus:function(){var a=this;a.txtAsk.focus();setTimeout(function(){a.txtAsk.focus()},150);a.h.style.width=a.txtAsk.offsetWidth+"px"}},selectIndex:0,user:d.User.get()},computed:{isValid:function(){return!!this.parReview.content}},methods:{load:function(){var a=this;d.post("api/Posting/GetPDiscuss",a.par,function(c){a.pageCount=c.Pages;1==a.par.pageIndex&&(a.o=c.Other);a.isUp?a.list=a.list.concat(c.Items):(a.list=c.Items,b("#pr").pullRefresh().refresh(!0));d.loadImg();d.ellipsisToggle();d.closeWaiting();b("#pr").pullRefresh().endPullupToRefresh(a.par.pageIndex>=a.pageCount)},function(){a.par.pageIndex--;d.closeWaiting();b("#pr").pullRefresh().endPullupToRefresh(!1)})},review:function(){var a=this,c=d.User.get();c.ImgUrl&&(c.NickName||c.RealName)?(d.showWaiting(),d.post("api/Posting/PDiscuss",a.parReview,function(e){1==a.parReview.discussType?(a.list.unshift({PDiscuss:{Name:c.NickName,ImgUrl:c.ImgUrl,IssDT:(new Date).toString().Format("yyyy-MM-dd hh:mm.ss"),Content:a.parReview.content,DisId:e,DNums:0,PNums:0},Replys:[]}),b(".mui-scroll-wrapper").scroll().scrollTo(0,0,100)):(a.list[a.selectIndex].PDiscuss.DNums++,a.list[a.selectIndex].Replys.unshift({Name:c.NickName,ImgUrl:c.ImgUrl,IssDT:(new Date).toString().Format("yyyy-MM-dd hh:mm.ss"),Content:a.parReview.content,rplId:e,DisId:a.par.postId,DNums:0,PNums:0}));b.fire(plus.webview.getWebviewById(a.pageid),"refreshNum",{ref:{type:1}});a.o.DNums++;a.parReview.content="";a.ui.txtAsk.value="";b.trigger(a.ui.txtAsk,"input",null);a.parReview.discussType=1;a.parReview.postId=a.par.postId;a.ui.txtAsk.blur();d.loadImg();d.closeWaiting()},function(){d.closeWaiting()})):b.toast(c.ImgUrl?"\u8bf7\u5148\u586b\u5199\u771f\u540d\u6216\u6635\u79f0":"\u8bf7\u5148\u4e0a\u4f20\u5934\u50cf")},initEvent:function(){var a=this;a.ui.footer.addEventListener("tap",function(a){a.preventDefault()});a.ui.txtAsk.addEventListener("tap",function(c){a.ui.txtFocus()},!1);a.ui.txtAsk.addEventListener("input",function(){a.ui.h.innerText=this.value.replace(RegExp("\n","gm"),"\n-")||"-";a.ui.footer.style.height=a.ui.h.offsetHeight+a.ui.footer.offsetHeight-this.offsetHeight+"px"});b("#app").on("tap",".y-attention",function(){var a=this,b="true"==a.dataset.isattention;d.post(b?"api/Posting/DeleteFocusUser":"api/Posting/AddFocusUser",{userID:a.dataset.userid},function(c){a.innerText=b?"+ \u5173\u6ce8":"\u53d6\u6d88\u5173\u6ce8";a.dataset.isattention=(!b).toString()})});b(".y-card-list").on("tap","a[data-type]",function(){var c=this,e=c.parentNode,f={postId:e.dataset.id,clickType:c.dataset.type},g=e.dataset.listIndex;switch(parseInt(c.dataset.type)){case 1:d.post("api/Posting/ClickLike",f,function(d){d=c.querySelector("i");d.classList.remove("y-collect-o");d.classList.add("y-collect");d.classList.add("y-yellow");a.o.CNums++;c.dataset.type=5;b.toast("\u6536\u85cf\u6210\u529f")});break;case 2:d.post("api/Posting/ClickLike",f,function(b){b=c.querySelector("i");b.classList.remove("y-heart-o");b.classList.add("y-heart");b.classList.add("y-red");a.o.PNums++;c.dataset.type=9});break;case 3:d.post("api/Posting/ClickLike",f,function(b){g=e.dataset.index;c.classList.remove("y-heart-o");c.classList.add("y-heart");c.classList.add("y-red");a.list[g].PDiscuss.PNums++;c.dataset.type=1E3});break;case 4:d.post("api/Posting/ClickLike",f,function(b){b=e.dataset.index;c.classList.remove("y-heart-o");c.classList.add("y-heart");c.classList.add("y-red");a.list[g].Replys[b].PNums++;c.dataset.type=1E3});break;case 5:d.post("api/Posting/ClickLike",f,function(d){d=c.querySelector("i");d.classList.add("y-collect-o");d.classList.remove("y-collect");d.classList.remove("y-yellow");a.o.CNums--;c.dataset.type=1;b.toast("\u53d6\u6d88\u6536\u85cf")});break;case 102:a.selectIndex=e.dataset.index,a.ui.txtAsk.placeholder="\u56de\u590d:"+a.list[a.selectIndex].PDiscuss.Name,a.ui.txtFocus(),a.parReview.discussType=2,a.parReview.postId=e.dataset.id}return!1});document.getElementById("pr").addEventListener("tap",function(){a.ui.txtAsk.placeholder="\u53d1\u8868\u8bc4\u8bba";a.parReview.discussType=1;a.parReview.postId=a.par.postId;a.ui.txtAsk.blur()});a.ui.btnSave.addEventListener("tap",function(b){b.preventDefault();a.review();return!1})}},ready:function(){var a=this;b.init({pullRefresh:{container:"#pr",up:{contentrefresh:"\u6b63\u5728\u52a0\u8f7d...",contentnomore:"\u5df2\u52a0\u8f7d\u5168\u90e8",callback:function(){a.par.pageIndex++;a.load()}}},gestureConfig:{tap:!0,doubletap:!0,longtap:!0,swipe:!0,drag:!0,hold:!0,release:!0}});b.ready(function(){a.initEvent();b.os.plus||(a.par.postId=d.getQueryString("ref.id"),a.pageid=d.getQueryString("ref.pageid"),a.parReview.postId=a.par.postId,b("#pr").pullRefresh().pullupLoading());b.previewImage();a.ui.h.style.width=a.ui.txtAsk.offsetWidth+"px"});b.plusReady(function(){plus.webview.currentWebview().setStyle({softinputMode:"adjustResize"});window.addEventListener("reload",function(c){a.user=d.User.get();a.par.postId=c.detail.ref.id;a.pageid=c.detail.ref.pageid;a.par.pageIndex=0;a.parReview.postId=a.par.postId;setTimeout(function(){b(".mui-scroll-wrapper").scroll().scrollTo(0,0,100)},500);setTimeout(function(){b("#pr").pullRefresh().pullupLoading()},1E3)});window.addEventListener("unload",function(c){a.list=[];a.o=null;b("#pr").pullRefresh().refresh(!0);a.parReview.content="";setTimeout(function(){b(".mui-scroll-wrapper").scroll().scrollTo(0,0,100)},500);a.ui.txtAsk.value="";b.trigger(a.ui.txtAsk,"input",null)});var c=plus.webview.currentWebview();c.ref&&(a.par.postId=c.ref.id,a.parReview.postId=a.par.postId,a.list=[],setTimeout(function(){b("#pr").pullRefresh().refresh(!0);b("#pr").pullRefresh().pullupLoading()},1E3))})}})});