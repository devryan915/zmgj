/*! JRoll v2.3.0 ~ (c) 2015-2016 Author:BarZu Git:https://git.oschina.net/chenjianlong/JRoll2/ Website:http://www.chjtx.com/JRoll/ */
/* global define*/(function(l,f,e){function q(){g.jrollActive&&g.jrollActive._end()}function v(){setTimeout(function(){for(var b in k)k[b].refresh().scrollTo(k[b].x,k[b].y,200)},600)}function w(b){var a=h.findScroller(b.target);a&&a._wheel(b)}var g,t=l.requestAnimationFrame||l.webkitRequestAnimationFrame||function(b){setTimeout(b,17)},n=f.createElement("div").style,k={},h,m=navigator.userAgent.toLowerCase();h={TSF:"transform"in n?"transform":"-webkit-transform",TSD:"transitionDuration"in n?"transition-duration":"-webkit-transition-duration",TFO:"transformOrigin"in n?"transform-origin":"-webkit-transform-origin",isAndroid:/android/.test(m),isIOS:/iphone|ipad/.test(m),isMobile:/mobile|phone|android|pad/.test(m),computePosition:function(b,a){for(var c=0,d=0;b;)c+=b.offsetLeft,d+=b.offsetTop,b=b.offsetParent,b===a&&(b=null);return{left:c,top:d}},moveTo:function(b,a,c,d,e){function r(){p-=17;0>=p?(k=a,l=c):(k=parseInt(k+n,10),l=parseInt(l+q,10));b.style[h.TSF]="translate("+k+"px, "+l+"px) translateZ(0px) scale("+m+")";0<p&&(k!==a||l!==c)?t(r):"function"===typeof e&&e()}var g=0,f=0,k,l,m=1,n,q,p,u;if(u=/translate\(([\-\d\.]+)px,\s+([\-\d\.]+)px\)\s+translateZ\(0px\)\s+scale\(([\d\.]+)\)/g.exec(b.style[h.TSF]))g=Number(u[1]),f=Number(u[2]),m=Number(u[3]);p=d||17;n=(a-g)/(p/17);q=(c-f)/(p/17);k=g;l=f;r()},findScroller:function(b,a){var c;if(a||!("TEXTAREA"===b.tagName&&b.scrollHeight>b.offsetHeight))for(;b!==f;){if(c=b.getAttribute("jroll-id"))return k[c];b=b.parentNode}return null}};f.addEventListener(h.isMobile?"touchstart":"mousedown",function(b){var a=h.findScroller(b.target);a?(g.jrollActive=a,a.moving&&(b.preventDefault(),a.moving=!1),a._start(b)):g.jrollActive=null},!1);f.addEventListener(h.isMobile?"touchmove":"mousemove",function(b){g.jrollActive&&(g.jrollActive.options.preventDefault&&b.preventDefault(),f.activeElement.blur(),g.jrollActive._move(b))},!1);f.addEventListener(h.isMobile?"touchend":"mouseup",q,!1);h.isMobile?f.addEventListener("touchcancel",q,!1):f.addEventListener(/firefox/.test(m)?"DOMMouseScroll":"mousewheel",w,!1);l.addEventListener("resize",v,!1);l.addEventListener("orientationchange",v,!1);g=function(b,a){this._init(b,a)};g.version="2.3.0";g.utils=h;g.jrollMap=k;g.prototype={_init:function(b,a){this.wrapper="string"===typeof b?f.querySelector(b):b;this.scroller=a&&a.scroller?"string"===typeof a.scroller?f.querySelector(a.scroller):a.scroller:this.wrapper.children[0];if(this.scroller.jroll)return this.scroller.jroll.refresh(),this.scroller.jroll;this.scroller.jroll=this;this.wrapperOffset=h.computePosition(this.wrapper,f.body);this.id=a&&a.id||this.scroller.getAttribute("jroll-id")||"jroll_"+e.random().toString().substr(2,8);this.scroller.setAttribute("jroll-id",this.id);k[this.id]=this;this.options={scrollX:!1,scrollY:!0,scrollFree:!1,minX:null,maxX:null,minY:null,maxY:null,zoom:!1,zoomMin:1,zoomMax:4,bounce:!0,scrollBarX:!1,scrollBarY:!1,scrollBarFade:!1,preventDefault:!0,momentum:!0,autoStyle:!0};for(var c in a)"scroller"!==c&&(this.options[c]=a[c]);this.options.autoStyle&&("static"===l.getComputedStyle(this.wrapper).position&&(this.wrapper.style.position="relative",this.wrapper.style.top="0",this.wrapper.style.left="0"),this.wrapper.style.overflow="hidden",this.scroller.style.minHeight="100%");this.y=this.x=0;this.scrollBarY=this.scrollBarX=this.s=null;this._s={startX:0,startY:0,lastX:0,lastY:0,endX:0,endY:0};this._z={spacing:0,scale:1,startScale:1};this._event={scrollStart:[],scroll:[],scrollEnd:[],zoomStart:[],zoom:[],zoomEnd:[],refresh:[],touchEnd:[]};this.refresh(!0)},enable:function(){this.scroller.setAttribute("jroll-id",this.id);return this},disable:function(){this.scroller.removeAttribute("jroll-id");return this},destroy:function(){delete k[this.id];delete this.scroller.jroll;this.scrollBarX&&this.wrapper.removeChild(this.scrollBarX);this.scrollBarY&&this.wrapper.removeChild(this.scrollBarY);this.disable();this.scroller.style[h.tSF]="";this.scroller.style[h.tSD]="";this.prototype=null;for(var b in this)this.hasOwnProperty(b)&&delete this[b]},call:function(b,a){this._s.lockX=!1;this._s.lockY=!1;this.scrollTo(this.x,this.y);g.jrollActive=b;a&&b._start(a);return b},refresh:function(b){var a=getComputedStyle(this.wrapper),c=getComputedStyle(this.scroller),d,r;this.wrapperWidth=this.wrapper.clientWidth;this.wrapperHeight=this.wrapper.clientHeight;this.scrollerWidth=e.round(this.scroller.offsetWidth*this._z.scale);this.scrollerHeight=e.round(this.scroller.offsetHeight*this._z.scale);d=parseInt(a["padding-left"])+parseInt(a["padding-right"]);a=parseInt(a["padding-top"])+parseInt(a["padding-bottom"]);r=parseInt(c["margin-left"])+parseInt(c["margin-right"]);c=parseInt(c["margin-top"])+parseInt(c["margin-bottom"]);this.minScrollX=null===this.options.minX?0:this.options.minX;this.maxScrollX=null===this.options.maxX?this.wrapperWidth-this.scrollerWidth-d-r:this.options.maxX;this.minScrollY=null===this.options.minY?0:this.options.minY;this.maxScrollY=null===this.options.maxY?this.wrapperHeight-this.scrollerHeight-a-c:this.options.maxY;0>this.minScrollX&&(this.minScrollX=0);0>this.minScrollY&&(this.minScrollY=0);0<this.maxScrollX&&(this.maxScrollX=0);0<this.maxScrollY&&(this.maxScrollY=0);this._s.endX=this.x;this._s.endY=this.y;this.options.scrollBarX?(this.scrollBarX||(d=this._createScrollBar("jroll-xbar","jroll-xbtn",!1),this.scrollBarX=d[0],this.scrollBtnX=d[1]),this.scrollBarScaleX=this.wrapper.clientWidth/this.scrollerWidth,d=e.round(this.scrollBarX.clientWidth*this.scrollBarScaleX),this.scrollBtnX.style.width=(8<d?d:8)+"px",this._runScrollBarX()):this.scrollBarX&&(this.wrapper.removeChild(this.scrollBarX),this.scrollBarX=null);this.options.scrollBarY?(this.scrollBarY||(d=this._createScrollBar("jroll-ybar","jroll-ybtn",!0),this.scrollBarY=d[0],this.scrollBtnY=d[1]),this.scrollBarScaleY=this.wrapper.clientHeight/this.scrollerHeight,d=e.round(this.scrollBarY.clientHeight*this.scrollBarScaleY),this.scrollBtnY.style.height=(8<d?d:8)+"px",this._runScrollBarY()):this.scrollBarY&&(this.wrapper.removeChild(this.scrollBarY),this.scrollBarY=null);b||this._execEvent("refresh");return this},scale:function(b){b=parseFloat(b);isNaN(b)||(this.scroller.style[h.TFO]="0 0",this._z.scale=b,this.refresh()._scrollTo(this.x,this.y),this.scrollTo(this.x,this.y,400));return this},_wheel:function(b){b=b.wheelDelta||120*-(b.detail/3);(this.options.scrollY||this.options.scrollFree)&&this.scrollTo(this.x,this._compute(this.y+b,this.minScrollY,this.maxScrollY))},_runScrollBarX:function(){var b=e.round(-1*this.x*this.scrollBarScaleX);this._scrollTo.call({scroller:this.scrollBtnX,_z:{scale:1}},b,0)},_runScrollBarY:function(){var b=e.round(-1*this.y*this.scrollBarScaleY);this._scrollTo.call({scroller:this.scrollBtnY,_z:{scale:1}},0,b)},_createScrollBar:function(b,a,c){var d,e;d=f.createElement("div");e=f.createElement("div");d.className=b;e.className=a;if(!0===this.options.scrollBarX||!0===this.options.scrollBarY)c?(d.style.cssText="position:absolute;top:2px;right:2px;bottom:2px;width:6px;overflow:hidden;border-radius:2px;-webkit-transform: scaleX(.5);transform: scaleX(.5);",e.style.cssText="background:rgba(0,0,0,.4);position:absolute;top:0;left:0;right:0;border-radius:2px;"):(d.style.cssText="position:absolute;left:2px;bottom:2px;right:2px;height:6px;overflow:hidden;border-radius:2px;-webkit-transform: scaleY(.5);transform: scaleY(.5);",e.style.cssText="background:rgba(0,0,0,.4);height:100%;position:absolute;left:0;top:0;bottom:0;border-radius:2px;");this.options.scrollBarFade&&(d.style.opacity=0);d.appendChild(e);this.wrapper.appendChild(d);return[d,e]},_fade:function(b,a){this.fading&&0<a&&(a-=25,0===a%100&&(b.style.opacity=a/1E3),t(this._fade.bind(this,b,a)))},on:function(b,a){switch(b){case "scrollStart":this._event.scrollStart.push(a);break;case "scroll":this._event.scroll.push(a);break;case "scrollEnd":this._event.scrollEnd.push(a);break;case "zoomStart":this._event.zoomStart.push(a);break;case "zoom":this._event.zoom.push(a);break;case "zoomEnd":this._event.zoomEnd.push(a);break;case "refresh":this._event.refresh.push(a);break;case "touchEnd":this._event.touchEnd.push(a)}},_execEvent:function(b,a){for(var c=this._event[b].length-1;0<=c;c--)this._event[b][c].call(this,a)},_compute:function(b,a,c){return b>a?this.options.bounce&&b>a+10?e.round(a+(b-a)/4):a:b<c?this.options.bounce&&b<c-10?e.round(c+(b-c)/4):c:b},_scrollTo:function(b,a){this.scroller.style[h.TSF]="translate("+b+"px, "+a+"px) translateZ(0px) scale("+this._z.scale+")"},scrollTo:function(b,a,c,d,e,g){d?(this.x=b,this.y=a):(this.x=b>=this.minScrollX?this.minScrollX:b<=this.maxScrollX?this.maxScrollX:b,this.y=a>=this.minScrollY?this.minScrollY:a<=this.maxScrollY?this.maxScrollY:a);g||(this._s.endX=this.x,this._s.endY=this.y);c?h.moveTo(this.scroller,this.x,this.y,c,e):(this._scrollTo(this.x,this.y),"function"===typeof e&&e());this.scrollBtnX&&this._runScrollBarX();this.scrollBtnY&&this._runScrollBarY();return this},_endAction:function(){this._s.endX=this.x;this._s.endY=this.y;this.moving=!1;this.options.scrollBarFade&&!this.fading&&(this.fading=!0,this.scrollBarX&&this._fade(this.scrollBarX,2E3),this.scrollBarY&&this._fade(this.scrollBarY,2E3));this._execEvent("scrollEnd")},_stepBounce:function(){function b(){a.scrollTo(a.x,a.y,100)}var a=this;a.bouncing=!1;"scrollY"===a.s?1===a.directionY?(a.scrollTo(a.x,a.minScrollY+20,100,!0,b),a.y=a.minScrollY):(a.scrollTo(a.x,a.maxScrollY-20,100,!0,b),a.y=a.maxScrollY):"scrollX"===a.s&&(1===a.directionX?(a.scrollTo(a.minScrollX+20,a.y,100,!0,b),a.x=a.minScrollX):(a.scrollTo(a.maxScrollX-20,a.y,100,!0,b),a.x=a.maxScrollX))},_x:function(b){b*=this.directionX;!isNaN(b)&&(this.x+=b,this.x>=this.minScrollX||this.x<=this.maxScrollX)&&(this.moving=!1,this.options.bounce&&(this.bouncing=!0))},_y:function(b){b*=this.directionY;!isNaN(b)&&(this.y+=b,this.y>=this.minScrollY||this.y<=this.maxScrollY)&&(this.moving=!1,this.options.bounce&&(this.bouncing=!0))},_xy:function(b){var a=e.round(this.cosX*b);b=e.round(this.cosY*b);isNaN(a)||isNaN(b)||(this.x+=a,this.y+=b,(this.x>=this.minScrollX||this.x<=this.maxScrollX)&&(this.y>=this.minScrollY||this.y<=this.maxScrollY)&&(this.moving=!1))},_step:function(b){var a=Date.now(),c=a-b;this.bouncing&&this._stepBounce();if(this.moving){if(10<c){this.speed-=c*(1.2<this.speed?.001:.6<this.speed?8E-4:6E-4);c=e.round(this.speed*c);if(0>=this.speed||0>=c){this._endAction();return}b=a;this._do(c);this.scrollTo(this.x,this.y,0,!1,null,!0);this._execEvent("scroll")}t(this._step.bind(this,b))}else this._endAction()},_doScroll:function(b,a){var c;this.distance=b;this.options.bounce&&(this.x=this._compute(this.x,this.minScrollX,this.maxScrollX),this.y=this._compute(this.y,this.minScrollY,this.maxScrollY));this.scrollTo(this.x,this.y,0,this.options.bounce,null,!0);this._execEvent("scroll",a);a&&a.touches&&(c=a.touches[0].pageY,(10>=c||c>=l.innerHeight-10)&&this._end())},_start:function(b){var a=b.touches||[b];if(!(this.options.scrollX||this.options.scrollY||this.options.scrollFree)||1!==a.length&&this.options.zoom){if(this.s=null,this.options.zoom&&1<a.length){this.s="preZoom";this.scroller.style[h.TFO]="0 0";var c=e.abs(a[0].pageX-a[1].pageX),d=e.abs(a[0].pageY-a[1].pageY);this._z.spacing=e.sqrt(c*c+d*d);this._z.startScale=this._z.scale;this.originX=e.abs(a[0].pageX+a[1].pageX)/2-this.wrapperOffset.left-this.x;this.originY=e.abs(a[0].pageY+a[1].pageY)/2-this.wrapperOffset.top-this.y;this._execEvent("zoomStart",b)}}else this.s="preScroll",this.distance=0,this.lastMoveTime=this.startTime=Date.now(),this._s.lastX=this.startPositionX=this._s.startX=a[0].pageX,this._s.lastY=this.startPositionY=this._s.startY=a[0].pageY,this._execEvent("scrollStart",b)},_move:function(b){var a=b.touches||[b],c,d,g,f,h;d=a[0].pageX;g=a[0].pageY;f=d-this._s.lastX;c=g-this._s.lastY;this._s.lastX=d;this._s.lastY=g;f=0<=f?1:-1;h=0<=c?1:-1;c=Date.now();if(200<c-this.lastMoveTime||this.directionX!==f||this.directionY!==h)this.startTime=c,this.startPositionX=d,this.startPositionY=g,this.directionX=f,this.directionY=h;this.lastMoveTime=c;f=d-this.startPositionX;c=g-this.startPositionY;if("preScroll"===this.s){this.options.scrollBarFade&&(this.fading=!1,this.scrollBarX&&(this.scrollBarX.style.opacity=1),this.scrollBarY&&(this.scrollBarY.style.opacity=1));if(!this.options.scrollFree&&this.options.scrollY&&(!this.options.scrollX||e.abs(g-this._s.startY)>=e.abs(d-this._s.startX))){this._do=this._y;this.s="scrollY";return}if(!this.options.scrollFree&&this.options.scrollX&&(!this.options.scrollY||e.abs(g-this._s.startY)<e.abs(d-this._s.startX))){this._do=this._x;this.s="scrollX";return}if(this.options.scrollFree){this._do=this._xy;this.s="scrollFree";return}}"scrollY"===this.s?(this.y=g-this._s.startY+this._s.endY,this._doScroll(c,b)):"scrollX"===this.s?(this.x=d-this._s.startX+this._s.endX,this._doScroll(f,b)):"scrollFree"===this.s?(this.x=d-this._s.startX+this._s.endX,this.y=g-this._s.startY+this._s.endY,a=e.sqrt(f*f+c*c),this.cosX=f/a,this.cosY=c/a,this._doScroll(e.sqrt(f*f+c*c),b)):"preZoom"===this.s&&(d=e.abs(a[0].pageX-a[1].pageX),a=e.abs(a[0].pageY-a[1].pageY),a=e.sqrt(d*d+a*a)/this._z.spacing*this._z.startScale,a<this.options.zoomMin?a=this.options.zoomMin:a>this.options.zoomMax&&(a=this.options.zoomMax),d=a/this._z.startScale,this.x=e.round(this.originX-this.originX*d+this._s.endX),this.y=e.round(this.originY-this.originY*d+this._s.endY),this._z.scale=a,this._scrollTo(this.x,this.y),this._execEvent("zoom",b))},_end:function(){var b,a,c=Date.now(),d="scrollY"===this.s,f="scrollX"===this.s,h="scrollFree"===this.s;g.jrollActive=null;this._execEvent("touchEnd");d||f||h?(this.duration=c-this.startTime,b=this.y>this.minScrollY||this.y<this.maxScrollY,a=this.x>this.minScrollX||this.x<this.maxScrollX,d&&b||f&&a||h&&(b||a)?this.scrollTo(this.x,this.y,300)._endAction():this.options.momentum&&200>this.duration&&this.distance?(this.speed=e.abs(this.distance/this.duration),this.speed=2<this.speed?2:this.speed,this.moving=!0,t(this._step.bind(this,c))):this._endAction()):"preZoom"===this.s?(this._z.scale>this.options.zoomMax?this._z.scale=this.options.zoomMax:this._z.scale<this.options.zoomMin&&(this._z.scale=this.options.zoomMin),this.refresh(),this.scrollTo(this.x,this.y,400),this._execEvent("zoomEnd")):"preScroll"!==this.s&&"preZoom"!==this.s||!this.options.scrollBarFade||this.fading||(this.fading=!0,this.scrollBarX&&this._fade(this.scrollBarX,2E3),this.scrollBarY&&this._fade(this.scrollBarY,2E3))}};"undefined"!==typeof module&&module.exports&&(module.exports=g);"function"===typeof define&&define(function(){return g});l.JRoll=g})(window,document,Math);